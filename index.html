
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA-G.V1 // NERV Data Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #050b0d;
            --bg-panel: #0a1619;
            --accent: #33cccc;
            --accent-dim: #1a4d4d;
            --text-main: #a3c2c2;
            --text-bright: #e6ffff;
            --border-color: #1f4d4d;
            --font-mono: 'JetBrains Mono', monospace;
            --font-sans: 'Inter', sans-serif;
            --drag-ghost: rgba(51, 204, 204, 0.1);
            --tag-bg: #112a2e;
            --transition: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-dim) transparent;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-sans);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* Background Effects */
        .bg-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .bg-grid {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(var(--bg-panel) 1px, transparent 1px), linear-gradient(90deg, var(--bg-panel) 1px, transparent 1px);
            background-size: 60px 60px;
            opacity: 0.3;
        }

        .stream-line {
            position: absolute;
            width: 1px;
            background: linear-gradient(to bottom, transparent, var(--accent), transparent);
            opacity: 0.1;
            animation: stream-down linear infinite;
        }

        @keyframes stream-down {
            from { transform: translateY(-100%); }
            to { transform: translateY(100%); }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes modalEnter {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes scanningLine {
            0% { left: -10%; }
            100% { left: 110%; }
        }

        #app {
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            position: relative;
            z-index: 10;
        }

        .system-bar {
            height: 45px;
            background: var(--bg-panel);
            border-bottom: 2px solid var(--accent);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 25px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--accent);
            letter-spacing: 2px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .view-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
        }

        #login-view {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            animation: fadeIn 0.5s var(--transition);
        }

        .terminal-box {
            width: 100%; max-width: 500px;
            background: var(--bg-panel);
            border: 1px solid var(--accent);
            padding: 50px;
            position: relative;
            box-shadow: 0 0 40px rgba(51, 204, 204, 0.1);
        }

        .btn {
            background: transparent; border: 1px solid var(--accent);
            color: var(--accent); padding: 10px 20px; cursor: pointer;
            font-family: var(--font-mono); font-weight: bold;
            text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.2s var(--transition);
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            height: 40px;
            white-space: nowrap;
        }
        .btn:hover { background: var(--accent); color: var(--bg-deep); box-shadow: 0 0 15px var(--accent); transform: translateY(-1px); }
        .btn-sm { padding: 6px 14px; font-size: 0.7rem; height: 32px; width: auto; }
        .btn-danger { color: #ff5555; border-color: #662222; }
        .btn-danger:hover { background: #ff5555; color: white; border-color: #ff5555; box-shadow: 0 0 15px #ff5555; }

        input, textarea, .rich-editor {
            width: 100%; background: rgba(0,0,0,0.5); 
            border: 1px solid var(--border-color);
            color: var(--text-bright); padding: 12px; 
            font-family: var(--font-mono); font-size: 0.95rem;
            outline: none; transition: 0.3s;
        }
        input:focus, textarea:focus, .rich-editor:focus { border-color: var(--accent); background: rgba(51, 204, 204, 0.08); }

        /* Rich Editor Tool Bar */
        .editor-toolbar {
            display: flex; gap: 5px;
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-bottom: none;
            padding: 5px;
            flex-wrap: wrap;
        }
        .editor-toolbar button, .editor-toolbar select {
            background: transparent; border: 1px solid var(--accent-dim);
            color: var(--accent); padding: 4px 8px;
            font-family: var(--font-mono); font-size: 0.65rem;
            cursor: pointer;
        }
        .editor-toolbar button:hover { background: var(--accent-dim); color: white; }
        .rich-editor {
            min-height: 300px;
            overflow-y: auto;
        }

        /* Dashboard Components */
        .dash-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 30px;
        }

        .control-strip {
            display: flex; gap: 15px; align-items: center;
            margin-bottom: 25px; flex-wrap: wrap;
        }

        /* Notes Grid */
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            grid-auto-rows: minmax(180px, auto);
            grid-auto-flow: dense;
            gap: 20px;
            width: 100%;
            padding-bottom: 100px;
        }

        .note-window {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            transition: all 0.3s var(--transition);
            cursor: grab;
            display: flex; flex-direction: column;
            animation: fadeIn 0.4s var(--transition);
            position: relative;
            overflow: hidden;
        }
        .note-window:hover { border-color: var(--accent); box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        
        .span-2-col { grid-column: span 2; }
        .span-2-row { grid-row: span 2; }
        .span-big { grid-column: span 2; grid-row: span 2; }

        .note-window.dragging { opacity: 0.2; transform: scale(0.95); }
        .note-window.drag-over { border-color: var(--accent); background: rgba(51, 204, 204, 0.05); }

        .window-header {
            background: var(--border-color); color: var(--accent);
            padding: 6px 12px; font-family: var(--font-mono);
            font-size: 0.65rem; display: flex; justify-content: space-between;
            pointer-events: none;
            z-index: 2;
        }

        .window-body { padding: 20px; flex: 1; pointer-events: none; z-index: 1; transition: max-height 0.4s var(--transition); }
        .window-body h3 { font-size: 1.1rem; color: var(--accent); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; position: relative; }
        .window-body p { font-size: 0.9rem; line-height: 1.5; color: var(--text-main); }
        .preview-expanded { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.5s var(--transition), opacity 0.5s var(--transition);
            opacity: 0;
            font-size: 0.8rem;
            color: var(--text-bright);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--accent-dim);
        }

        /* Scanning Line */
        .scanning-indicator {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 2px;
            background: var(--accent);
            display: none;
            z-index: 10;
            box-shadow: 0 0 10px var(--accent);
        }

        .note-window:hover .scanning-indicator {
            display: block;
            animation: scanningLine 0.8s linear infinite;
        }
        
        /* Loading Status Text */
        .scanning-text {
            position: absolute;
            top: 30px;
            right: 15px;
            font-family: var(--font-mono);
            font-size: 0.6rem;
            color: var(--accent);
            display: none;
        }
        .note-window:hover .scanning-text { display: block; }

        /* Expand body on hover */
        .note-window:hover .preview-expanded {
            max-height: 500px;
            opacity: 1;
        }

        .nested-container {
            margin: 10px; padding: 15px;
            background: rgba(0,0,0,0.4);
            border: 1px dashed var(--accent-dim);
            min-height: 80px; display: flex; flex-direction: column; gap: 12px;
            pointer-events: auto;
        }

        .window-footer {
            padding: 8px 12px; font-family: var(--font-mono);
            font-size: 0.6rem; color: var(--accent-dim);
            border-top: 1px solid rgba(51, 204, 204, 0.05);
            display: flex; justify-content: space-between;
            z-index: 2;
        }

        .tags-manager {
            display: flex; flex-wrap: wrap; gap: 10px;
            margin-bottom: 30px; padding: 15px;
            background: rgba(0,0,0,0.2); border: 1px solid var(--border-color);
        }
        .tag-pill {
            padding: 4px 12px; background: var(--tag-bg);
            border: 1px solid var(--accent-dim); color: var(--accent);
            font-size: 0.7rem; font-family: var(--font-mono);
            cursor: pointer; transition: 0.2s;
        }
        .tag-pill:hover, .tag-pill.active { background: var(--accent); color: var(--bg-deep); }

        /* Modals */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 11, 13, 0.9); z-index: 10000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
            transition: opacity 0.3s var(--transition);
        }

        .modal-window {
            background: var(--bg-panel); border: 1px solid var(--accent);
            max-width: 1000px; width: 90%; position: relative;
            box-shadow: 0 0 50px rgba(51, 204, 204, 0.2);
            animation: modalEnter 0.3s var(--transition);
        }

        .modal-header {
            padding: 20px 30px; background: var(--accent); color: var(--bg-deep);
            font-family: var(--font-mono); font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }

        .modal-body { padding: 40px; overflow-y: auto; max-height: 80vh; }

        .content-display {
            background: rgba(0,0,0,0.5); border: 1px solid var(--border-color);
            padding: 30px; color: var(--text-bright);
            font-family: var(--font-mono); line-height: 1.8;
            margin-bottom: 30px; white-space: pre-wrap;
            font-size: 1.05rem; border-left: 4px solid var(--accent);
        }
        .content-display div, .content-display span, .preview-expanded div, .preview-expanded span { font-family: var(--font-mono); }

        #logs {
            position: fixed; bottom: 20px; left: 20px;
            font-family: var(--font-mono); font-size: 0.65rem; color: var(--accent-dim);
            max-width: 400px; pointer-events: none;
        }

        @media (max-width: 800px) {
            .notes-grid { grid-template-columns: 1fr; }
            .span-2-col, .span-big { grid-column: span 1; }
            .dash-header { flex-direction: column; align-items: flex-start; gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="bg-container" id="stream-bg">
        <div class="bg-grid"></div>
    </div>
    
    <div id="app">
        <div class="system-bar">
            <div>EVA-G.V1 // MAGI_SYSTEM_CORE</div>
            <div id="status-display">SYNC_RATE: <span style="color: #00ffaa;">41.3% (STABLE)</span> // NODES: <span id="node-count">0</span></div>
            <div id="clock">00:00:00</div>
        </div>

        <div id="view-port" class="view-container">
            <!-- LOGIN VIEW -->
            <div id="login-view">
                <div class="terminal-box">
                    <h2 style="font-family: var(--font-mono); color: var(--accent); margin-bottom: 40px; letter-spacing: 5px; text-align: center;">NERV_ACCESS_PROTOCOL</h2>
                    <form id="login-form">
                        <div class="field" style="margin-bottom: 25px;">
                            <label style="display: block; font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent); margin-bottom: 10px;">OPERATOR_IDENTIFICATION</label>
                            <input type="email" id="login-email" value="deemo@gmail.com" required>
                        </div>
                        <div class="field" style="margin-bottom: 30px;">
                            <label style="display: block; font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent); margin-bottom: 10px;">SECURITY_OVERRIDE_KEY</label>
                            <input type="password" id="login-password" required placeholder="********">
                        </div>
                        <div id="login-error" style="display: none; color: #ff5555; font-size: 0.75rem; margin-bottom: 25px; text-align: center; border: 1px solid #622; padding: 12px; font-family: var(--font-mono);">[!] ACCESS_DENIED: LCL_CONTAMINATION_DETECTED</div>
                        <button type="submit" class="btn" style="width: 100%;">ESTABLISH_NEURAL_LINK</button>
                    </form>
                </div>
            </div>

            <!-- DASHBOARD VIEW -->
            <div id="dashboard-view" style="display: none; animation: fadeIn 0.5s var(--transition);">
                <div class="dash-header">
                    <div>
                        <h1 style="font-family: var(--font-mono); font-size: 3rem; color: var(--text-bright); letter-spacing: 8px;">EVA-G.V1</h1>
                        <div id="user-display" style="font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent-dim); margin-top: 5px;"></div>
                    </div>
                    <div style="text-align: right;">
                        <div id="dash-realtime-clock" style="font-family: var(--font-mono); color: var(--accent); font-size: 1.8rem; letter-spacing: 2px;">00:00:00</div>
                        <div style="font-family: var(--font-mono); font-size: 0.6rem; color: var(--accent-dim);">NERV_STANDARD_TIME</div>
                    </div>
                </div>
                
                <div class="control-strip">
                    <button id="btn-add" class="btn btn-sm">GENERATE_NODE</button>
                    <button id="btn-add-group" class="btn btn-sm">CREATE_SECTOR</button>
                    <button id="btn-manage-tags" class="btn btn-sm">DATA_CLASSIFICATION</button>
                    <div style="flex: 1; min-width: 250px;">
                        <input type="text" id="search-input" placeholder="Execute Pattern Blue search..." style="height: 32px; padding: 0 15px; font-size: 0.8rem;">
                    </div>
                    <button id="btn-logout" class="btn btn-sm btn-danger">TERMINATE_LINK</button>
                </div>

                <div id="tags-filter-bar" class="tags-manager"></div>

                <div id="notes-grid" class="notes-grid"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: EDITOR -->
    <div id="edit-modal" class="overlay">
        <div class="modal-window">
            <div class="modal-header">
                <span id="edit-modal-title">TACTICAL_DATA_ENTRY</span>
                <span style="cursor: pointer;" onclick="closeModal('edit-modal')">[ ABORT_X ]</span>
            </div>
            <div class="modal-body">
                <form id="note-form">
                    <input type="hidden" id="note-id">
                    <input type="hidden" id="note-type" value="note">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent); margin-bottom: 8px;">NODE_IDENTIFIER</label>
                        <input type="text" id="note-title" required placeholder="Ex: ANGEL_PATTERN_EX01">
                    </div>
                    <div id="note-content-field" style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent); margin-bottom: 8px;">INTELLIGENCE_PAYLOAD</label>
                        <div class="editor-toolbar">
                            <button type="button" onclick="formatDoc('bold')">B</button>
                            <button type="button" onclick="formatDoc('italic')">I</button>
                            <select onchange="formatDoc('forecolor', this.value); this.value=''">
                                <option value="">COLOR</option>
                                <option value="#33cccc">TEAL</option>
                                <option value="#ff5555">RED</option>
                                <option value="#00ffaa">GREEN</option>
                                <option value="#ffffff">WHITE</option>
                            </select>
                            <select onchange="formatDoc('fontsize', this.value); this.value=''">
                                <option value="">SIZE</option>
                                <option value="2">SMALL</option>
                                <option value="3">NORMAL</option>
                                <option value="5">LARGE</option>
                                <option value="7">HUGE</option>
                            </select>
                        </div>
                        <div id="note-rich-content" class="rich-editor" contenteditable="true"></div>
                    </div>
                    <div style="margin-bottom: 30px;">
                        <label style="display: block; font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent); margin-bottom: 8px;">TAGS (CLASSIFICATION_GROUP)</label>
                        <input type="text" id="note-tags" placeholder="tactical, bio, third_child">
                    </div>
                    <div style="display: flex; gap: 20px; justify-content: flex-end;">
                        <button type="button" class="btn btn-sm btn-danger" onclick="closeModal('edit-modal')">DISCARD</button>
                        <button type="submit" class="btn btn-sm">COMMIT_TO_MAGI</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: VIEW -->
    <div id="view-modal" class="overlay">
        <div class="modal-window">
            <div class="modal-header">
                <span id="view-header-tag">DECRYPTED_INTEL_STREAM</span>
                <span style="cursor: pointer;" onclick="closeModal('view-modal')">[ DISMISS ]</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div id="view-tags-container" style="display: flex; gap: 8px;"></div>
                    <span style="font-family: var(--font-mono); font-size: 0.6rem; color: var(--accent-dim);">H_ID: <span id="view-id-display"></span></span>
                </div>
                <h2 id="view-title" style="font-family: var(--font-mono); font-size: 2.2rem; margin-bottom: 20px; color: var(--accent); letter-spacing: 2px;"></h2>
                <div style="display: flex; justify-content: space-between; font-family: var(--font-mono); font-size: 0.8rem; color: var(--accent-dim); margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;">
                    <span id="view-author"></span>
                    <span id="view-date"></span>
                </div>
                <div id="view-content" class="content-display"></div>
                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                    <button id="btn-view-delete-trigger" class="btn btn-sm btn-danger">EXPUNGE_DATA</button>
                    <button id="btn-view-edit" class="btn btn-sm">RE_SYNC</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CONFIRM DELETE -->
    <div id="confirm-delete-modal" class="overlay">
        <div class="modal-window" style="max-width: 450px; border-color: #ff5555;">
            <div class="modal-header" style="background: #ff5555; color: white;">
                <span>PURGE_AUTHORIZATION_REQUIRED</span>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="margin-bottom: 30px; font-family: var(--font-mono);">WARNING: Permanently EXPUNGE this data node from EVA-G.V1 system?</p>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-sm" style="flex: 1;" onclick="closeModal('confirm-delete-modal')">ABORT</button>
                    <button id="btn-view-delete-final" class="btn btn-sm btn-danger" style="flex: 1;">EXECUTE_PURGE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: TAGS -->
    <div id="tag-modal" class="overlay">
        <div class="modal-window" style="max-width: 550px;">
            <div class="modal-header">
                <span>GLOBAL_DATA_REGISTRY</span>
                <span style="cursor: pointer;" onclick="closeModal('tag-modal')">[ DISMISS ]</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 25px;">
                    <label style="display: block; font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent); margin-bottom: 10px;">REGISTER_NEW_TAG</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-tag-input" placeholder="Pattern name...">
                        <button id="btn-save-tag" class="btn btn-sm">REGISTER</button>
                    </div>
                </div>
                <div id="tags-list-manager" style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); padding: 15px;"></div>
            </div>
        </div>
    </div>

    <div id="logs"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, push, set, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCQTr3D2G5CKO5FA4h3-SrAfBKL27zqhrQ",
            authDomain: "bazarnovareal-2a2e1.firebaseapp.com",
            databaseURL: "https://bazarnovareal-2a2e1-default-rtdb.firebaseio.com",
            projectId: "bazarnovareal-2a2e1",
            storageBucket: "bazarnovareal-2a2e1.firebasestorage.app",
            messagingSenderId: "86223881317",
            appId: "1:86223881317:web:f80d2fbc8d0c7c5e15b28c"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getDatabase(firebaseApp);

        let currentUser = null;
        let allItems = [];
        let allTags = [];
        let activeTagFilter = null;
        let currentViewingId = null;
        let draggedId = null;

        // Rich Editor Function
        window.formatDoc = (cmd, val) => {
            document.execCommand(cmd, false, val);
        };

        // Background Animation Lines
        const bg = document.getElementById('stream-bg');
        for(let i=0; i<35; i++) {
            const line = document.createElement('div');
            line.className = 'stream-line';
            line.style.left = Math.random() * 100 + '%';
            line.style.height = (Math.random() * 80 + 80) + 'px';
            line.style.animationDuration = (Math.random() * 4 + 3) + 's';
            line.style.animationDelay = Math.random() * 5 + 's';
            bg.appendChild(line);
        }

        const show = (id) => { 
            const el = document.getElementById(id);
            el.style.display = 'flex';
            setTimeout(() => el.style.opacity = '1', 10);
        };
        const hide = (id) => { 
            const el = document.getElementById(id);
            el.style.opacity = '0';
            setTimeout(() => el.style.display = 'none', 300);
        };
        window.closeModal = (id) => hide(id);

        function sysLog(msg) {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.innerText = `> [${new Date().toLocaleTimeString()}] ${msg}`;
            div.style.animation = 'fadeIn 0.3s ease-out';
            logs.prepend(div);
            if (logs.children.length > 7) logs.lastChild.remove();
        }

        setInterval(() => {
            const now = new Date().toLocaleTimeString('pt-BR');
            const clocks = [document.getElementById('clock'), document.getElementById('dash-realtime-clock')];
            clocks.forEach(c => c && (c.innerText = now));
        }, 1000);

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                hide('login-view');
                document.getElementById('dashboard-view').style.display = 'block';
                document.getElementById('user-display').innerText = `OPERATOR: ${user.email.split('@')[0].toUpperCase()} // MAGI_AUTH: BALTHASAR_ACCEPTED`;
                initData();
                sysLog("LINK_STABLE: NEURAL_CONNECT_STABLISHED");
            } else {
                show('login-view');
                document.getElementById('dashboard-view').style.display = 'none';
                sysLog("LINK_OFFLINE: WAITING_FOR_THIRD_CHILD");
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                document.getElementById('login-error').style.display = 'block';
                sysLog("AUTH_FAILURE: MAGI_REJECTION_BALTHASAR");
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        function initData() {
            onValue(ref(db, `items/${currentUser.uid}`), (snapshot) => {
                const data = snapshot.val();
                allItems = data ? Object.keys(data).map(id => ({ id, ...data[id] })) : [];
                allItems.sort((a, b) => (a.order || 0) - (b.order || 0));
                document.getElementById('node-count').innerText = allItems.length;
                renderDashboard();
            });

            onValue(ref(db, `tags/${currentUser.uid}`), (snapshot) => {
                const data = snapshot.val();
                allTags = data ? Object.keys(data).map(id => ({ id, ...data[id] })) : [];
                renderTagsBar();
            });
        }

        function renderTagsBar() {
            const bar = document.getElementById('tags-filter-bar');
            bar.innerHTML = `<span class="tag-pill ${!activeTagFilter?'active':''}" onclick="setFilter(null)">ALL_INTEL_STREAM</span>`;
            allTags.forEach(t => {
                bar.innerHTML += `<span class="tag-pill ${activeTagFilter === t.name?'active':''}" onclick="setFilter('${t.name}')">${t.name.toUpperCase()}</span>`;
            });
        }

        window.setFilter = (tagName) => {
            activeTagFilter = tagName;
            renderTagsBar();
            renderDashboard();
        };

        function renderDashboard() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const grid = document.getElementById('notes-grid');
            grid.innerHTML = '';

            // Recursive search: If a child matches, its parent should be included.
            const matchedIds = new Set();
            allItems.forEach(item => {
                const titleMatch = item.title.toLowerCase().includes(search);
                const contentMatch = (item.content || '').toLowerCase().includes(search);
                const tagMatch = !activeTagFilter || (item.tags && item.tags.includes(activeTagFilter));
                
                if ((titleMatch || contentMatch) && tagMatch) {
                    matchedIds.add(item.id);
                    // Add all ancestors to matchedIds to ensure the tree path is visible
                    let current = item;
                    while (current.parentId) {
                        matchedIds.add(current.parentId);
                        current = allItems.find(i => i.id === current.parentId);
                        if (!current) break;
                    }
                }
            });

            // If search is empty and no tag filter, show all root items
            let itemsToRender;
            if (!search && !activeTagFilter) {
                itemsToRender = allItems;
            } else {
                itemsToRender = allItems.filter(i => matchedIds.has(i.id));
            }

            const rootItems = itemsToRender.filter(i => !i.parentId);
            rootItems.forEach(item => grid.appendChild(createItemElement(item, itemsToRender)));
        }

        function createItemElement(item, allFiltered) {
            const div = document.createElement('div');
            
            const complexity = (item.title.length + (item.content?.length || 0));
            let spanClass = '';
            if (item.type === 'group' || complexity > 250) spanClass = 'span-big';
            else if (complexity > 120) spanClass = complexity % 2 === 0 ? 'span-2-col' : 'span-2-row';
            
            div.className = `note-window type-${item.type || 'note'} ${spanClass}`;
            div.draggable = true;
            div.dataset.id = item.id;
            
            const tagsHtml = (item.tags || []).map(t => `<span class="tag-pill" style="padding:1px 6px; font-size:0.55rem; margin-right:4px;">${t}</span>`).join('');
            
            // Limit preview content for card preview
            const plainTextPreview = (item.content || '').replace(/<[^>]*>?/gm, '').slice(0, 180);

            div.innerHTML = `
                <div class="scanning-indicator"></div>
                <div class="scanning-text">SCANNING...</div>
                <div class="window-header">
                    <span>${item.type.toUpperCase()}_NODE: ${item.id.slice(0,8).toUpperCase()}</span>
                    <span>:::</span>
                </div>
                <div class="window-body">
                    <h3>${item.title}</h3>
                    <p>${item.type === 'group' ? '[ CLASSIFIED_SECTOR ]' : plainTextPreview + '...'}</p>
                    <div class="preview-expanded">
                        ${item.type === 'note' ? item.content : '[ SECTOR_FILE_DIRECTORY_LOCKED ]'}
                    </div>
                    <div style="margin-top:15px;">${tagsHtml}</div>
                </div>
                ${item.type === 'group' ? `<div class="nested-container" data-parent-id="${item.id}"></div>` : ''}
                <div class="window-footer">
                    <span>SYNC_DATE: ${new Date(item.updatedAt).toLocaleDateString()}</span>
                </div>
            `;

            if (item.type === 'group') {
                const container = div.querySelector('.nested-container');
                const children = allFiltered.filter(i => i.parentId === item.id);
                children.forEach(child => container.appendChild(createItemElement(child, allFiltered)));

                container.addEventListener('dragover', e => { e.preventDefault(); container.classList.add('drag-over'); });
                container.addEventListener('dragleave', () => container.classList.remove('drag-over'));
                container.addEventListener('drop', e => {
                    e.preventDefault(); e.stopPropagation();
                    container.classList.remove('drag-over');
                    if (draggedId && draggedId !== item.id) moveToGroup(draggedId, item.id);
                });
            }

            div.addEventListener('dragstart', e => { e.stopPropagation(); draggedId = item.id; div.classList.add('dragging'); });
            div.addEventListener('dragend', () => { div.classList.remove('dragging'); draggedId = null; });
            div.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); div.classList.add('drag-over'); });
            div.addEventListener('dragleave', () => div.classList.remove('drag-over'));
            div.addEventListener('drop', e => {
                e.preventDefault(); e.stopPropagation();
                div.classList.remove('drag-over');
                if (draggedId && draggedId !== item.id) handleDataSwap(draggedId, item.id);
            });
            div.addEventListener('click', e => { e.stopPropagation(); viewNote(item.id); });

            return div;
        }

        async function handleDataSwap(idA, idB) {
            const itemA = allItems.find(i => i.id === idA);
            const itemB = allItems.find(i => i.id === idB);
            if (!itemA || !itemB) return;

            const updates = {};
            const orderA = itemA.order || Date.now();
            const orderB = itemB.order || Date.now();

            updates[`items/${currentUser.uid}/${idA}/order`] = orderB;
            updates[`items/${currentUser.uid}/${idB}/order`] = orderA;
            updates[`items/${currentUser.uid}/${idA}/parentId`] = itemB.parentId || null;

            await update(ref(db), updates);
        }

        async function moveToGroup(childId, groupId) {
            if (childId === groupId) return;
            sysLog(`OPS: RECLASSIFYING_NODE_${childId.slice(0,4)}`);
            await update(ref(db, `items/${currentUser.uid}/${childId}`), { parentId: groupId, updatedAt: Date.now() });
        }

        document.getElementById('btn-add').addEventListener('click', () => { resetForm(); document.getElementById('note-type').value = 'note'; show('edit-modal'); });
        document.getElementById('btn-add-group').addEventListener('click', () => { resetForm(); document.getElementById('note-type').value = 'group'; document.getElementById('note-content-field').style.display = 'none'; show('edit-modal'); });

        function resetForm() { 
            document.getElementById('note-form').reset(); 
            document.getElementById('note-id').value = ''; 
            document.getElementById('note-rich-content').innerHTML = '';
            document.getElementById('note-content-field').style.display = 'block'; 
        }

        document.getElementById('note-form').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('note-id').value;
            const type = document.getElementById('note-type').value;
            const tags = document.getElementById('note-tags').value.split(',').map(t => t.trim().toLowerCase()).filter(t => t);
            
            const payload = {
                title: document.getElementById('note-title').value,
                type: type,
                content: type === 'note' ? document.getElementById('note-rich-content').innerHTML : '',
                tags: tags,
                updatedAt: Date.now(),
                order: id ? allItems.find(i => i.id === id).order : Date.now()
            };

            tags.forEach(t => { if (!allTags.find(gt => gt.name === t)) push(ref(db, `tags/${currentUser.uid}`), { name: t }); });

            if (id) await update(ref(db, `items/${currentUser.uid}/${id}`), payload);
            else push(ref(db, `items/${currentUser.uid}`), { ...payload, parentId: null });
            
            hide('edit-modal');
            sysLog("LINK_STABLE: COMMIT_COMMITTED_TO_MAGI");
        });

        window.viewNote = (id) => {
            const item = allItems.find(i => i.id === id);
            if (!item) return;
            currentViewingId = id;
            document.getElementById('view-title').innerText = item.title;
            document.getElementById('view-content').innerHTML = item.type === 'note' ? item.content : '[ SECTOR_FILE_DIRECTORY_LOCKED ]';
            document.getElementById('view-author').innerText = `NODE_CLASS: ${item.type.toUpperCase()}`;
            document.getElementById('view-date').innerText = `LAST_SYNC: ${new Date(item.updatedAt).toLocaleString()}`;
            document.getElementById('view-id-display').innerText = id.toUpperCase();
            document.getElementById('view-tags-container').innerHTML = (item.tags || []).map(t => `<span class="tag-pill active">${t}</span>`).join('');
            show('view-modal');
        };

        document.getElementById('btn-view-edit').addEventListener('click', () => {
            const item = allItems.find(i => i.id === currentViewingId);
            document.getElementById('note-id').value = item.id;
            document.getElementById('note-type').value = item.type;
            document.getElementById('note-title').value = item.title;
            document.getElementById('note-rich-content').innerHTML = item.content || '';
            document.getElementById('note-tags').value = (item.tags || []).join(', ');
            document.getElementById('note-content-field').style.display = item.type === 'group' ? 'none' : 'block';
            hide('view-modal'); show('edit-modal');
        });

        document.getElementById('btn-view-delete-trigger').addEventListener('click', () => {
            show('confirm-delete-modal');
        });

        document.getElementById('btn-view-delete-final').addEventListener('click', async () => {
            if (currentViewingId) {
                const children = allItems.filter(i => i.parentId === currentViewingId);
                children.forEach(c => update(ref(db, `items/${currentUser.uid}/${c.id}`), { parentId: null }));
                await remove(ref(db, `items/${currentUser.uid}/${currentViewingId}`));
                hide('confirm-delete-modal');
                hide('view-modal');
                sysLog("PURGE_COMPLETE: NODE_EXPUNGED");
            }
        });

        document.getElementById('btn-manage-tags').addEventListener('click', () => {
            const list = document.getElementById('tags-list-manager');
            list.innerHTML = '';
            allTags.forEach(t => {
                const row = document.createElement('div');
                row.style.cssText = 'display:flex; justify-content:space-between; margin-bottom:10px; padding:8px; border-bottom:1px solid #1f4d4d';
                row.innerHTML = `<span style="font-family:var(--font-mono); font-size:0.8rem;">${t.name}</span> <button class="btn btn-sm btn-danger" onclick="deleteTag('${t.id}')">UNREGISTER</button>`;
                list.appendChild(row);
            });
            show('tag-modal');
        });

        window.deleteTag = async (tid) => {
            await remove(ref(db, `tags/${currentUser.uid}/${tid}`));
            hide('tag-modal');
            sysLog("OPS: TAG_UNREGISTERED");
        };

        document.getElementById('btn-save-tag').addEventListener('click', async () => {
            const name = document.getElementById('new-tag-input').value.trim().toLowerCase();
            if (name && !allTags.find(t => t.name === name)) {
                await push(ref(db, `tags/${currentUser.uid}`), { name });
                document.getElementById('new-tag-input').value = '';
                hide('tag-modal');
                sysLog("OPS: PATTERN_REGISTERED");
            }
        });

        document.getElementById('search-input').addEventListener('input', renderDashboard);
    </script>
</body>
</html>
