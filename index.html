
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAGI-B01 // Gestão Papelaria</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #050b0d;
            --bg-panel: #0a1619;
            --accent: #33cccc;
            --accent-dim: #1a4d4d;
            --text-main: #a3c2c2;
            --text-bright: #e6ffff;
            --border-color: #1f4d4d;
            --font-mono: 'JetBrains Mono', monospace;
            --font-sans: 'Inter', sans-serif;
            --drag-ghost: rgba(51, 204, 204, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-dim) transparent;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-sans);
            overflow-x: hidden;
            height: 100vh;
            width: 100vw;
        }

        .bg-grid {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(var(--bg-panel) 1px, transparent 1px), linear-gradient(90deg, var(--bg-panel) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: -1;
            opacity: 0.5;
        }

        .side-decoration {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 250px;
            font-family: var(--font-mono);
            font-size: 0.6rem;
            color: var(--accent-dim);
            pointer-events: none;
            line-height: 1.2;
            z-index: 0;
            opacity: 0.6;
        }

        #app {
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            position: relative;
            z-index: 10;
        }

        .system-bar {
            height: 40px;
            background: var(--bg-panel);
            border-bottom: 2px solid var(--accent);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--accent);
            letter-spacing: 1px;
        }

        .view-container {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        #login-view {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        .terminal-box {
            width: 100%; max-width: 420px;
            background: var(--bg-panel);
            border: 1px solid var(--accent);
            padding: 40px;
            position: relative;
            box-shadow: 0 0 20px rgba(51, 204, 204, 0.1);
        }

        .terminal-box::before {
            content: "AUTH_REQUIRED";
            position: absolute; top: -10px; left: 20px;
            background: var(--bg-deep); padding: 0 10px;
            font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent);
        }

        .field { margin-bottom: 20px; }
        .field label { 
            display: block; font-family: var(--font-mono);
            font-size: 0.7rem; color: var(--accent); 
            margin-bottom: 8px; text-transform: uppercase;
        }
        input, textarea {
            width: 100%; background: rgba(0,0,0,0.3); 
            border: 1px solid var(--border-color);
            color: var(--text-bright); padding: 12px; 
            font-family: var(--font-mono); font-size: 0.9rem;
            outline: none; transition: 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--accent); background: rgba(51, 204, 204, 0.05); }

        .btn {
            background: transparent; border: 1px solid var(--accent);
            color: var(--accent); padding: 12px; cursor: pointer;
            font-family: var(--font-mono); font-weight: bold;
            text-transform: uppercase; letter-spacing: 2px;
            transition: 0.3s; width: 100%;
        }
        .btn:hover { background: var(--accent); color: var(--bg-deep); box-shadow: 0 0 15px var(--accent); }
        .btn-sm { padding: 6px 14px; font-size: 0.75rem; width: auto; }
        .btn-danger { color: #ff5555; border-color: #662222; }
        .btn-danger:hover { background: #ff5555; color: white; box-shadow: 0 0 15px #ff5555; }

        #dashboard-view {
            display: none;
            width: 100%;
            flex-direction: column;
        }

        .dash-header { margin-bottom: 40px; }
        .dash-title {
            font-family: var(--font-mono); font-size: 2.8rem;
            color: var(--text-bright); margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(51, 204, 204, 0.4);
        }
        .dash-clock { font-family: var(--font-mono); font-size: 1.2rem; color: var(--accent); opacity: 0.8; }

        /* Re-organized Grid Layout */
        .notes-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            width: 100%;
        }

        .note-window {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            position: relative; transition: 0.2s;
            cursor: grab;
        }
        .note-window:active { cursor: grabbing; }
        .note-window:hover { border-color: var(--accent); }
        .note-window.dragging { opacity: 0.4; border-style: dashed; }
        .note-window.drag-over { border-color: var(--accent); box-shadow: inset 0 0 20px var(--drag-ghost); transform: scale(1.02); }
        
        .window-header {
            background: var(--border-color); color: var(--bg-deep);
            padding: 4px 12px; font-family: var(--font-mono);
            font-size: 0.65rem; display: flex; justify-content: space-between;
            pointer-events: none;
        }

        .window-body { padding: 20px; pointer-events: none; }
        .window-body h3 { font-size: 1rem; color: var(--accent); margin-bottom: 10px; text-transform: uppercase; }
        .window-body p { font-size: 0.85rem; line-height: 1.5; color: var(--text-main); max-height: 4.5em; overflow: hidden; }

        .window-footer {
            padding: 8px 12px; font-family: var(--font-mono);
            font-size: 0.6rem; color: var(--accent-dim);
            border-top: 1px solid rgba(51, 204, 204, 0.1);
            display: flex; justify-content: space-between;
            pointer-events: none;
        }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 11, 13, 0.9); z-index: 10000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }

        .modal-window {
            background: var(--bg-panel); border: 2px solid var(--accent);
            max-width: 850px; width: 95%; position: relative;
        }

        .modal-header {
            padding: 15px 25px; background: var(--accent); color: var(--bg-deep);
            font-family: var(--font-mono); font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }

        .modal-body { padding: 40px; }

        .content-display {
            background: rgba(0,0,0,0.4); border: 1px solid var(--border-color);
            padding: 25px; border-radius: 4px; color: var(--text-bright);
            font-family: var(--font-mono); line-height: 1.6;
            margin-bottom: 30px; white-space: pre-wrap;
        }

        .stat-badge {
            display: inline-block; padding: 2px 8px;
            background: var(--accent-dim); color: var(--accent);
            font-family: var(--font-mono); font-size: 0.6rem; border-radius: 2px;
        }

        #logs {
            position: fixed; bottom: 20px; left: 20px;
            font-family: var(--font-mono); font-size: 0.6rem; color: var(--accent-dim);
            max-width: 300px;
        }

        @media (max-width: 1000px) {
            .notes-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    
    <div class="side-decoration">
<pre>
// MAGI_B01_STATUS
[SYSTEM_INIT] ... OK
[PRINTER_LINK] .. ONLINE
[STOCK_SYNC] ... 98.4%

def scan_grid():
  for node in nodes:
    if node.id == target:
      return node.data
  return null

# FVWM_TERMINAL_V3
User: Isolated
Mode: DragDrop_Active
Reorder: Priority_Based
</pre>
    </div>

    <div id="app">
        <div class="system-bar">
            <div>MAGI_B01 // OPERATIONAL_UNIT</div>
            <div>STATUS: <span style="color: #00ffaa;">STABLE</span></div>
            <div id="clock">00:00:00</div>
        </div>

        <div id="view-port" class="view-container">
            <!-- LOGIN -->
            <div id="login-view">
                <div class="terminal-box">
                    <h2 style="font-family: var(--font-mono); color: var(--accent); margin-bottom: 30px; letter-spacing: 4px;">SYSTEM_ACCESS</h2>
                    <form id="login-form">
                        <div class="field">
                            <label>ID_OPERATOR</label>
                            <input type="email" id="login-email" value="deemo@gmail.com" required>
                        </div>
                        <div class="field">
                            <label>SECURITY_KEY</label>
                            <input type="password" id="login-password" required placeholder="********">
                        </div>
                        <div id="login-error" style="display: none; color: #ff5555; font-size: 0.7rem; margin-bottom: 20px; font-family: var(--font-mono);">[!] ERR_AUTH_FAILED: ACCESS_DENIED</div>
                        <button type="submit" class="btn">INITIALIZE_SESSION</button>
                    </form>
                </div>
            </div>

            <!-- DASHBOARD -->
            <div id="dashboard-view">
                <div class="dash-header">
                    <h1 class="dash-title">MAGI-B01</h1>
                    <div id="dash-realtime-clock" class="dash-clock">00:00:00</div>
                </div>
                
                <p id="user-display" style="font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent-dim); margin-bottom: 30px;"></p>

                <div style="display: flex; gap: 15px; margin-bottom: 40px;">
                    <button id="btn-add" class="btn btn-sm">NEW_PROTOCOL</button>
                    <button id="btn-logout" class="btn btn-sm btn-danger">TERMINATE_LINK</button>
                </div>

                <div class="field" style="margin-bottom: 50px;">
                    <label>SEARCH_DATA_GRID</label>
                    <input type="text" id="search-input" placeholder="Execute search command...">
                </div>

                <div id="notes-grid" class="notes-grid"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: EDITOR -->
    <div id="edit-modal" class="overlay">
        <div class="modal-window">
            <div class="modal-header">
                <span id="edit-modal-title">COMMIT_DATA_ENTRY</span>
                <span style="cursor: pointer;" onclick="closeModal('edit-modal')">[ X ]</span>
            </div>
            <div class="modal-body">
                <form id="note-form">
                    <input type="hidden" id="note-id">
                    <div class="field">
                        <label>IDENTIFIER_TAG</label>
                        <input type="text" id="note-title" required placeholder="Boleto_Escaneamento_01">
                    </div>
                    <div class="field">
                        <label>OPERATOR_SIGNATURE</label>
                        <input type="text" id="note-author" value="Giancarlo" required>
                    </div>
                    <div class="field">
                        <label>RAW_DATA_STREAM (INSTRUCTIONS/LINKS)</label>
                        <textarea id="note-content" style="height: 250px;" required placeholder="Enter procedures or URLs..."></textarea>
                    </div>
                    <div style="display: flex; gap: 20px; justify-content: flex-end;">
                        <button type="button" class="btn btn-sm btn-danger" onclick="closeModal('edit-modal')">ABORT</button>
                        <button type="submit" class="btn btn-sm">EXECUTE_COMMIT</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: VISUALIZAR -->
    <div id="view-modal" class="overlay">
        <div class="modal-window" style="max-width: 900px;">
            <div class="modal-header">
                <span id="view-header-tag">RECORD_ANALYSIS_VIEW</span>
                <span style="cursor: pointer;" onclick="closeModal('view-modal')">[ CLOSE ]</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 25px; text-align: right;">
                    <span class="stat-badge">PROTOCOL_ID: <span id="view-id-display"></span></span>
                </div>
                <h2 id="view-title" style="font-family: var(--font-mono); font-size: 2.2rem; margin-bottom: 15px; color: var(--accent);"></h2>
                <div style="display: flex; justify-content: space-between; font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent-dim); margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;">
                    <span id="view-author"></span>
                    <span id="view-date"></span>
                </div>
                <div id="view-content" class="content-display"></div>
                <div style="display: flex; gap: 20px; justify-content: flex-end;">
                    <button id="btn-view-delete" class="btn btn-sm btn-danger">WIPE_DATA</button>
                    <button id="btn-view-edit" class="btn btn-sm">MODIFY_RECORD</button>
                    <div style="margin-left: 10px; border-left: 1px solid var(--border-color); padding-left: 20px;">
                        <button onclick="event.stopPropagation(); editNote(currentViewingId)" class="btn btn-sm" style="display:none;">MOD</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: DELETE -->
    <div id="delete-modal" class="overlay">
        <div class="modal-window" style="max-width: 450px; border-color: #ff5555;">
            <div class="modal-header" style="background: #662222; color: #ff5555;">
                <span>DESTRUCTION_WARNING</span>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="margin-bottom: 30px; font-family: var(--font-mono); color: var(--text-main);">Confirm permanent data wipe?</p>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-sm" style="flex: 1;" onclick="closeModal('delete-modal')">CANCEL</button>
                    <button id="btn-confirm-delete" class="btn btn-sm btn-danger" style="flex: 1;">EXECUTE_WIPE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="logs"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, push, set, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCQTr3D2G5CKO5FA4h3-SrAfBKL27zqhrQ",
            authDomain: "bazarnovareal-2a2e1.firebaseapp.com",
            databaseURL: "https://bazarnovareal-2a2e1-default-rtdb.firebaseio.com",
            projectId: "bazarnovareal-2a2e1",
            storageBucket: "bazarnovareal-2a2e1.firebasestorage.app",
            messagingSenderId: "86223881317",
            appId: "1:86223881317:web:f80d2fbc8d0c7c5e15b28c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let notes = [];
        let noteToDeleteId = null;
        let currentViewingId = null;
        let draggedNoteId = null;

        const show = (id, flex=true) => {
            const el = document.getElementById(id);
            if(el) el.style.display = flex ? 'grid' : 'block';
        };
        const hide = (id) => {
            const el = document.getElementById(id);
            if(el) el.style.display = 'none';
        };
        window.closeModal = (id) => hide(id);

        function sysLog(msg) {
            const logs = document.getElementById('logs');
            if(!logs) return;
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            logs.prepend(div);
            if (logs.children.length > 8) logs.lastChild.remove();
        }

        setInterval(() => {
            const now = new Date().toLocaleTimeString('pt-BR');
            const clockEl = document.getElementById('clock');
            if(clockEl) clockEl.innerText = now;
            const dashClockEl = document.getElementById('dash-realtime-clock');
            if(dashClockEl) dashClockEl.innerText = now;
        }, 1000);

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                hide('login-view');
                show('dashboard-view', true);
                const userDisplay = document.getElementById('user-display');
                if(userDisplay) userDisplay.innerText = `OPERATOR_ID: ${user.email.split('@')[0].toUpperCase()} // SESS_STABLE`;
                initDashboard();
                sysLog("MAGI_B01: CONNECTION_ESTABLISHED");
            } else {
                show('login-view');
                hide('dashboard-view');
                sysLog("MAGI_B01: WAITING_FOR_AUTH");
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                const errEl = document.getElementById('login-error');
                if(errEl) errEl.style.display = 'block';
                sysLog("ERROR: AUTH_REJECTED");
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
            sysLog("LINK_TERMINATED");
            signOut(auth);
        });

        function initDashboard() {
            const notesRef = ref(db, `notes/${currentUser.uid}`);
            onValue(notesRef, (snapshot) => {
                const data = snapshot.val();
                notes = data ? Object.keys(data).map(id => ({ id, ...data[id] })) : [];
                // Ordenar por 'order' field (ascendente)
                notes.sort((a, b) => (a.order || 0) - (b.order || 0));
                renderNotes();
            });
        }

        function renderNotes() {
            const searchInput = document.getElementById('search-input');
            const term = searchInput ? searchInput.value.toLowerCase() : '';
            const filtered = notes.filter(n => 
                n.title.toLowerCase().includes(term) || 
                n.content.toLowerCase().includes(term)
            );
            
            const grid = document.getElementById('notes-grid');
            if(!grid) return;
            grid.innerHTML = '';

            if (filtered.length === 0) {
                grid.innerHTML = '<p style="color: var(--accent-dim); font-family: var(--font-mono); grid-column: 1 / -1;">[ NO_DATA_DETECTED ]</p>';
                return;
            }

            filtered.forEach((note) => {
                const div = document.createElement('div');
                div.className = 'note-window';
                div.draggable = true;
                div.dataset.id = note.id;
                div.innerHTML = `
                    <div class="window-header">
                        <span>IDENT: ${note.id.slice(0,10).toUpperCase()}</span>
                        <span>[ GRAB_TO_REORDER ]</span>
                    </div>
                    <div class="window-body">
                        <h3>${note.title}</h3>
                        <p>${note.content}</p>
                    </div>
                    <div class="window-footer">
                        <span>SIG: ${note.author.toUpperCase()}</span>
                        <span>UPD: ${new Date(note.updatedAt).toLocaleDateString()}</span>
                    </div>
                `;

                // Drag Events
                div.addEventListener('dragstart', (e) => {
                    draggedNoteId = note.id;
                    div.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                div.addEventListener('dragend', () => {
                    div.classList.remove('dragging');
                    draggedNoteId = null;
                    document.querySelectorAll('.note-window').forEach(el => el.classList.remove('drag-over'));
                });

                div.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedNoteId !== note.id) {
                        div.classList.add('drag-over');
                    }
                });

                div.addEventListener('dragleave', () => {
                    div.classList.remove('drag-over');
                });

                div.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedNoteId && draggedNoteId !== note.id) {
                        handleSwap(draggedNoteId, note.id);
                    }
                });

                div.addEventListener('click', (e) => {
                    if (e.target.closest('.note-window')) {
                        viewNote(note.id);
                    }
                });

                grid.appendChild(div);
            });
        }

        async function handleSwap(sourceId, targetId) {
            const source = notes.find(n => n.id === sourceId);
            const target = notes.find(n => n.id === targetId);
            if (!source || !target) return;

            const tempOrder = source.order || 0;
            const newSourceOrder = target.order || 0;
            const newTargetOrder = tempOrder;

            sysLog(`REORDERING: ${sourceId.slice(0,6)} <-> ${targetId.slice(0,6)}`);

            const updates = {};
            updates[`notes/${currentUser.uid}/${sourceId}/order`] = newSourceOrder;
            updates[`notes/${currentUser.uid}/${targetId}/order`] = newTargetOrder;

            await update(ref(db), updates);
        }

        document.getElementById('search-input').addEventListener('input', renderNotes);

        window.viewNote = (id) => {
            const note = notes.find(n => n.id === id);
            if (!note) return;
            currentViewingId = id;
            document.getElementById('view-title').innerText = note.title;
            document.getElementById('view-content').innerText = note.content;
            document.getElementById('view-author').innerText = `ASSINATURA: ${note.author}`;
            document.getElementById('view-date').innerText = `ÚLTIMA_SINCRONIA: ${new Date(note.updatedAt).toLocaleString()}`;
            document.getElementById('view-id-display').innerText = id.toUpperCase();
            show('view-modal', true);
            sysLog(`ACCESSING_RECORD: ${id.slice(0,6)}`);
        };

        window.editNote = (id) => {
            const note = notes.find(n => n.id === id);
            if (!note) return;
            document.getElementById('note-id').value = note.id;
            document.getElementById('note-title').value = note.title;
            document.getElementById('note-author').value = note.author;
            document.getElementById('note-content').value = note.content;
            document.getElementById('edit-modal-title').innerText = 'RECONFIG_PROTOCOL_DATA';
            show('edit-modal', true);
            hide('view-modal');
        };

        window.requestDelete = (id) => {
            noteToDeleteId = id;
            show('delete-modal', true);
        };

        document.getElementById('btn-confirm-delete').addEventListener('click', async () => {
            if (noteToDeleteId) {
                await remove(ref(db, `notes/${currentUser.uid}/${noteToDeleteId}`));
                hide('delete-modal');
                hide('view-modal');
                sysLog("DATA_PURGED_SUCCESSFULLY");
            }
        });

        document.getElementById('btn-add').addEventListener('click', () => {
            document.getElementById('note-form').reset();
            document.getElementById('note-id').value = '';
            document.getElementById('edit-modal-title').innerText = 'INITIALIZE_NEW_COMMIT';
            show('edit-modal', true);
        });

        document.getElementById('note-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('note-id').value;
            const noteData = {
                title: document.getElementById('note-title').value,
                author: document.getElementById('note-author').value,
                content: document.getElementById('note-content').value,
                updatedAt: Date.now()
            };

            if (id) {
                await update(ref(db, `notes/${currentUser.uid}/${id}`), noteData);
                sysLog("COMMIT_UPDATED");
            } else {
                const maxOrder = notes.length > 0 ? Math.max(...notes.map(n => n.order || 0)) : 0;
                noteData.order = maxOrder + 1;
                const newRef = push(ref(db, `notes/${currentUser.uid}`));
                await set(newRef, noteData);
                sysLog("COMMIT_UPLOADED");
            }
            hide('edit-modal');
        });

        document.getElementById('btn-view-edit').addEventListener('click', () => editNote(currentViewingId));
        document.getElementById('btn-view-delete').addEventListener('click', () => requestDelete(currentViewingId));

    </script>
</body>
</html>
