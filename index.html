
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVA REAL - Terminal v3.5</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff0000;
            --primary-dim: #800000;
            --primary-dark: #300000;
            --primary-bg: #020000;
            --glow: 0 0 15px rgba(255, 0, 0, 0.6);
            --font-mono: 'JetBrains Mono', monospace;
            --font-terminal: 'VT323', monospace;
            --circuit-line: #600000;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-dim) transparent;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--primary);
            font-family: var(--font-mono);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* Hacker Background Effects */
        .bg-stripes {
            position: fixed;
            top: 0; right: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(-45deg, transparent, transparent 50px, rgba(255, 0, 0, 0.02) 50px, rgba(255, 0, 0, 0.02) 100px);
            pointer-events: none; z-index: 1;
        }

        .grid-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(255, 0, 0, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 0, 0, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none; z-index: 1;
        }

        .scanline {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%);
            background-size: 100% 4px;
            pointer-events: none; z-index: 1001; opacity: 0.3;
        }

        .crt-vignette {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 60%, rgba(0,0,0,0.8) 100%);
            pointer-events: none; z-index: 1000;
        }

        #app {
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            position: relative; z-index: 10;
        }

        /* Top System Bar */
        .top-bar {
            height: 35px;
            background: #000;
            border-bottom: 1px solid var(--primary-dim);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; font-size: 0.7rem; letter-spacing: 1px;
            color: var(--primary-dim);
        }

        /* View Containers */
        .view-container {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            position: relative;
        }

        #login-view {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        #dashboard-view {
            display: none;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            text-align: left;
        }

        /* Login Box Styling */
        .login-box {
            width: 100%; max-width: 420px;
            border: 1px solid var(--primary);
            background: rgba(10, 0, 0, 0.95);
            padding: 50px 40px;
            box-shadow: 0 0 40px rgba(255, 0, 0, 0.25);
            position: relative;
        }

        .login-box::before {
            content: "[ PROTOCOLO DE ACESSO ]";
            position: absolute; top: -12px; left: 50%;
            transform: translateX(-50%);
            background: var(--primary-bg); padding: 0 15px; font-size: 0.65rem; color: var(--primary);
            letter-spacing: 2px;
        }

        /* Form Elements */
        .field { margin-bottom: 25px; }
        .field label { display: block; font-size: 0.65rem; color: var(--primary-dim); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        input, textarea {
            width: 100%; background: #000; border: 1px solid var(--primary-dark);
            color: var(--primary); padding: 14px; font-family: var(--font-mono);
            font-size: 0.9rem; outline: none; transition: 0.2s;
        }
        input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 12px rgba(255,0,0,0.3); }

        .btn {
            background: rgba(255, 0, 0, 0.1); border: 1px solid var(--primary);
            color: var(--primary); padding: 14px 24px; cursor: pointer;
            font-family: var(--font-mono); text-transform: uppercase; font-weight: bold;
            letter-spacing: 2px; transition: 0.3s; width: 100%;
        }
        .btn:hover { background: var(--primary); color: #000; box-shadow: var(--glow); }
        .btn-sm { padding: 8px 16px; font-size: 0.75rem; width: auto; }
        .btn-danger { color: #f44; border-color: #600; background: rgba(100, 0, 0, 0.1); }
        .btn-danger:hover { background: #800; color: #fff; }

        /* Dashboard Aesthetic */
        .dash-title-group { margin-bottom: 15px; }
        .dash-actions-group { display: flex; gap: 15px; margin-bottom: 25px; }

        .sys-panels-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;
            margin-bottom: 30px;
        }

        .sys-panel {
            border: 1px solid var(--primary-dark); padding: 12px; font-size: 0.6rem;
            background: rgba(255, 0, 0, 0.02); line-height: 1.5;
            border-left: 2px solid var(--primary-dim);
        }

        /* --- MIND MAP / CIRCUIT SYSTEM --- */
        .notes-grid {
            position: relative;
            margin-top: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 250px;
            min-height: 600px;
        }

        /* Linha Central do Circuito (Trunk) */
        .notes-grid::before {
            content: "";
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 150px;
            width: 2px;
            background: linear-gradient(to bottom, transparent, var(--primary), var(--primary-dim), transparent);
            box-shadow: 0 0 12px rgba(255, 0, 0, 0.4);
            transform: translateX(-50%);
            z-index: 1;
        }

        /* Note Node Wrapper */
        .note-node {
            width: 100%;
            display: flex;
            justify-content: center;
            position: relative;
            margin-bottom: 80px;
            perspective: 1000px;
        }

        /* Circuit Branch (Linha de conexão horizontal) */
        .note-node::before {
            content: "";
            position: absolute;
            top: 40px;
            width: 80px;
            height: 2px;
            background: var(--primary-dim);
            z-index: 0;
        }

        /* Ponto de conexão no tronco */
        .note-node::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 36px;
            width: 10px;
            height: 10px;
            background: var(--primary);
            border: 2px solid #000;
            border-radius: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 10px var(--primary);
            z-index: 2;
        }

        /* Alternância de Lados */
        .note-node:nth-child(even) { justify-content: flex-start; padding-left: 10%; }
        .note-node:nth-child(odd) { justify-content: flex-end; padding-right: 10%; }

        .note-node:nth-child(even)::before { left: 50%; transform: translateX(-100%); width: calc(40% - 50px); top: 50px; }
        .note-node:nth-child(odd)::before { right: 50%; transform: translateX(100%); width: calc(40% - 50px); top: 50px; }

        /* Terminal Style Note Cards */
        .terminal-card {
            border: 1px solid var(--primary-dim); background: rgba(5, 0, 0, 0.95);
            display: flex; flex-direction: column; transition: 0.4s;
            cursor: pointer; position: relative;
            width: 420px;
            max-width: 90%;
            z-index: 5;
            box-shadow: 10px 10px 0px rgba(255, 0, 0, 0.05);
        }

        .terminal-card::after {
            content: "";
            position: absolute;
            top: -1px; left: -1px; right: -1px; bottom: -1px;
            border: 1px solid var(--primary-dim);
            pointer-events: none;
            opacity: 0.3;
        }

        .terminal-card:hover { 
            border-color: var(--primary); 
            transform: scale(1.02) translateY(-5px); 
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.2); 
            z-index: 10;
        }

        .terminal-header {
            height: 30px; background: var(--primary-dark);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; font-size: 0.65rem; border-bottom: 1px solid var(--primary-dim);
            letter-spacing: 1.5px;
        }

        .terminal-body { padding: 25px; flex: 1; position: relative; overflow: hidden; }
        .terminal-body::before {
            content: ""; position: absolute; top: 0; right: 0; width: 40px; height: 40px;
            background: linear-gradient(135deg, transparent 50%, var(--primary-dark) 50%);
        }

        .terminal-body h3 { font-size: 1.2rem; margin-bottom: 12px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .terminal-body p { font-size: 0.85rem; color: #cc0000; line-height: 1.6; height: 60px; overflow: hidden; font-family: var(--font-terminal); }

        .terminal-footer {
            padding: 10px 20px; font-size: 0.6rem; border-top: 1px solid var(--primary-dark);
            color: var(--primary-dim); display: flex; justify-content: space-between;
            background: rgba(255, 0, 0, 0.02);
        }

        /* Overlay & Modals */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.96); z-index: 10000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(15px); padding: 20px;
        }

        .modal {
            background: #010000; border: 1px solid var(--primary);
            max-width: 900px; width: 100%; position: relative;
            box-shadow: 0 0 100px rgba(255, 0, 0, 0.5);
            animation: modal-entry 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modal-entry { from { opacity: 0; transform: translateY(50px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .modal-header {
            padding: 18px 30px; background: var(--primary-dark);
            border-bottom: 1px solid var(--primary); display: flex;
            justify-content: space-between; align-items: center;
            font-size: 0.9rem; font-weight: bold; letter-spacing: 3px;
        }

        .modal-body { padding: 45px; max-height: 85vh; overflow-y: auto; }

        .view-content-area {
            font-family: var(--font-mono); font-size: 1.1rem; line-height: 1.8;
            color: #ff3333; white-space: pre-wrap; margin-bottom: 40px;
            padding: 35px; background: rgba(255, 0, 0, 0.05);
            border: 1px solid var(--primary-dark);
            box-shadow: inset 0 0 20px rgba(255, 0, 0, 0.1);
        }

        /* Visual Effects */
        .glitch { animation: glitch-anim 6s infinite; }
        @keyframes glitch-anim {
            0%, 90% { transform: none; opacity: 1; }
            92% { transform: translate(4px, -3px); opacity: 0.8; text-shadow: 2px 0 #800; }
            94% { transform: translate(-4px, 3px); opacity: 0.9; text-shadow: -2px 0 #f00; }
            96% { transform: translate(2px, -2px); }
        }

        .loading-bar { width: 100%; height: 4px; background: var(--primary-dark); position: relative; overflow: hidden; }
        .loading-bar::after {
            content: ""; position: absolute; left: 0; height: 100%; width: 40%;
            background: var(--primary); animation: loading-sweep 3s infinite linear;
        }
        @keyframes loading-sweep { 0% { left: -40%; } 100% { left: 100%; } }

        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: #000; color: var(--primary); z-index: 2000;
        }

        #logs {
            position: fixed; bottom: 25px; left: 25px; font-size: 0.65rem;
            color: var(--primary-dim); z-index: 100; max-width: 380px;
            pointer-events: none; background: rgba(0,0,0,0.7); padding: 12px;
            border-left: 3px solid var(--primary);
        }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; background: var(--primary); box-shadow: 0 0 10px var(--primary); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* Estilo Arvore/Pattern Connections */
        .pattern-connection {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0; left: 0;
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div class="glitch" style="font-size: 1.5rem; letter-spacing: 4px; font-family: var(--font-terminal);">GIANCARLO_SYSTEM_STATION // INIT_SEQUENCE...</div>
    </div>

    <div class="bg-stripes"></div>
    <div class="grid-bg"></div>
    <div class="scanline"></div>
    <div class="crt-vignette"></div>

    <div id="app">
        <!-- Status Bar -->
        <div class="top-bar">
            <div>NOVA_REAL_TERMINAL // SECURITY_PROTOCOL_v3.5</div>
            <div id="top-stats">IP: 192.168.1.104 | LOAD: 15% | RAM: 2.4GB</div>
            <div id="clock">00:00:00</div>
        </div>

        <div id="view-port" class="view-container">
            <!-- LOGIN -->
            <div id="login-view">
                <div class="login-box">
                    <div class="loading-bar" style="margin-bottom: 45px;"></div>
                    <h1 class="glitch" style="font-size: 2.8rem; margin-bottom: 10px; text-align: center; letter-spacing: 6px;">NOVA REAL</h1>
                    <p style="font-size: 0.7rem; text-align: center; color: var(--primary-dim); letter-spacing: 8px; margin-bottom: 45px; text-transform: uppercase;">Acesso Restrito</p>
                    
                    <form id="login-form">
                        <div class="field">
                            <label>OPERATOR_IDENT</label>
                            <input type="email" id="login-email" value="deemo@gmail.com" required>
                        </div>
                        <div class="field">
                            <label>SECURITY_PASSKEY</label>
                            <input type="password" id="login-password" required placeholder="CHAVE_DE_ACESSO">
                        </div>
                        <div id="login-error" style="display: none; color: #f00; font-size: 0.8rem; margin-bottom: 25px; text-align: center; border: 1px solid #600; padding: 12px; background: rgba(50,0,0,0.5);">[!] ERRO CRÍTICO: ACESSO NEGADO</div>
                        <button type="submit" class="btn">INICIAR SESSÃO SEGURA</button>
                    </form>
                    <div style="margin-top: 35px; text-align: center; font-size: 0.6rem; color: #500; letter-spacing: 3px;">GIANCARLO_OS // ESTAÇÃO MONITORADA</div>
                </div>
            </div>

            <!-- DASHBOARD -->
            <div id="dashboard-view">
                <div class="dash-title-group">
                    <h1 class="glitch" style="font-size: 3.5rem; letter-spacing: 4px;">DASHBOARD_CENTRAL</h1>
                    <p id="user-display" style="font-size: 0.8rem; color: var(--primary-dim); margin-top: 8px; font-weight: bold; letter-spacing: 2px;"></p>
                </div>

                <div class="dash-actions-group">
                    <button id="btn-add" class="btn btn-sm">NOVO_REGISTRO</button>
                    <button id="btn-logout" class="btn btn-sm btn-danger">LOGOUT</button>
                </div>

                <div class="field" style="max-width: 650px; margin-bottom: 50px;">
                    <label>FILTRAGEM_DE_DADOS_GRID</label>
                    <input type="text" id="search-input" placeholder="BUSCAR CID, CONTEÚDO OU OPERADOR NO SISTEMA...">
                </div>

                <div class="sys-panels-grid">
                    <div class="sys-panel">
                        <span style="color: var(--primary)">DADOS:</span> RTDB_STABLE<br>
                        <span style="color: var(--primary)">CRIPT:</span> AES-256-V3<br>
                        <span style="color: var(--primary)">SYNC:</span> ONLINE
                    </div>
                    <div class="sys-panel">
                        <span style="color: var(--primary)">PING:</span> 14ms<br>
                        <span style="color: var(--primary)">ESTADO:</span> MONITORADO<br>
                        <span style="color: var(--primary)">LAST:</span> <span id="sync-time">NOW</span>
                    </div>
                    <div class="sys-panel">
                        <span style="color: var(--primary)">OP:</span> GIANCARLO<br>
                        <span style="color: var(--primary)">UPLINK:</span> CRYPTO_SAT<br>
                        <span style="color: var(--primary)">VER:</span> 3.5.0-ST
                    </div>
                </div>

                <div id="notes-grid" class="notes-grid">
                    <!-- Gerado dinamicamente com nós alternados -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: EDITOR -->
    <div id="edit-modal" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <span id="edit-modal-title">SISTEMA_DE_COMMIT</span>
                <span style="cursor: pointer;" onclick="closeModal('edit-modal')">[ X ]</span>
            </div>
            <div class="modal-body">
                <form id="note-form">
                    <input type="hidden" id="note-id">
                    <div class="field">
                        <label>TÍTULO_DO_REGISTRO (CID)</label>
                        <input type="text" id="note-title" required placeholder="EX: OPERAÇÃO_DELTA">
                    </div>
                    <div class="field">
                        <label>ASSINATURA_DO_OPERADOR</label>
                        <input type="text" id="note-author" value="Giancarlo" required>
                    </div>
                    <div class="field">
                        <label>DADOS_CRIPTOGRAFADOS (TEXTO/PROTOCOLO)</label>
                        <textarea id="note-content" style="height: 280px;" required placeholder="Insira os dados confidenciais aqui..."></textarea>
                    </div>
                    <div style="display: flex; gap: 20px;">
                        <button type="button" class="btn btn-danger" onclick="closeModal('edit-modal')">DESCARTAR</button>
                        <button type="submit" class="btn">EFETIVAR_REGISTRO</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: VISUALIZAR -->
    <div id="view-modal" class="overlay">
        <div class="modal" style="max-width: 1000px;">
            <div class="modal-header">
                <span id="view-header-tag">DADOS_DECRIPTADOS_VISTA</span>
                <span style="cursor: pointer;" onclick="closeModal('view-modal')">[ X ]</span>
            </div>
            <div class="modal-body">
                <h2 id="view-title" class="glitch" style="margin-bottom: 20px; font-size: 2.8rem; text-transform: uppercase; color: var(--primary); letter-spacing: 2px;"></h2>
                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--primary-dim); margin-bottom: 40px; border-bottom: 1px solid var(--primary-dark); padding-bottom: 15px; letter-spacing: 2px;">
                    <span id="view-author"></span>
                    <span id="view-date"></span>
                </div>
                <div id="view-content" class="view-content-area"></div>
                <div style="display: flex; gap: 25px; justify-content: flex-end;">
                    <button id="btn-view-delete" class="btn btn-sm btn-danger" style="min-width: 180px;">EXPURGAR_DADOS</button>
                    <button id="btn-view-edit" class="btn btn-sm" style="min-width: 180px;">EDITAR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: DELETE -->
    <div id="delete-modal" class="overlay">
        <div class="modal" style="max-width: 480px; border-color: #f00;">
            <div class="modal-header" style="background: #500;">
                <span>AVISO_DE_EXPURGO</span>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="margin-bottom: 40px; font-size: 1.1rem; line-height: 1.6; font-family: var(--font-terminal);">ESTE REGISTRO SERÁ PERMANENTEMENTE REMOVIDO DO BANCO CENTRAL DE DADOS. <br><br>DESEJA CONFIRMAR O EXPURGO?</p>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-sm" style="flex: 1;" onclick="closeModal('delete-modal')">ABORTAR</button>
                    <button id="btn-confirm-delete" class="btn btn-sm btn-danger" style="flex: 1;">DESTRUIR_DATA</button>
                </div>
            </div>
        </div>
    </div>

    <div id="logs"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, push, set, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCQTr3D2G5CKO5FA4h3-SrAfBKL27zqhrQ",
            authDomain: "bazarnovareal-2a2e1.firebaseapp.com",
            databaseURL: "https://bazarnovareal-2a2e1-default-rtdb.firebaseio.com",
            projectId: "bazarnovareal-2a2e1",
            storageBucket: "bazarnovareal-2a2e1.firebasestorage.app",
            messagingSenderId: "86223881317",
            appId: "1:86223881317:web:f80d2fbc8d0c7c5e15b28c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let notes = [];
        let noteToDeleteId = null;
        let currentViewingId = null;

        const show = (id, flex=true) => {
            const el = document.getElementById(id);
            if(el) el.style.display = flex ? 'flex' : 'block';
        };
        const hide = (id) => {
            const el = document.getElementById(id);
            if(el) el.style.display = 'none';
        };
        window.closeModal = (id) => hide(id);

        function sysLog(msg) {
            const logs = document.getElementById('logs');
            if(!logs) return;
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            logs.prepend(div);
            if (logs.children.length > 10) logs.lastChild.remove();
        }

        setInterval(() => {
            const clockEl = document.getElementById('clock');
            if(clockEl) clockEl.innerText = new Date().toLocaleTimeString();
            
            const statsEl = document.getElementById('top-stats');
            if (statsEl && Math.random() > 0.85) {
                const cpu = Math.floor(Math.random() * 30) + 10;
                const mem = (Math.random() * 2 + 2).toFixed(1);
                statsEl.innerText = `IP: 192.168.1.104 | LOAD: ${cpu}% | RAM: ${mem}GB`;
            }
        }, 1000);

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const loadingScreen = document.getElementById('loading-screen');
            if(loadingScreen) loadingScreen.style.display = 'none';
            
            if (user) {
                hide('login-view');
                show('dashboard-view', false);
                const userDisplay = document.getElementById('user-display');
                if(userDisplay) userDisplay.innerText = `OPERADOR_ATUANTE: ${user.email.toUpperCase()} // STATUS: MONITORAMENTO_ATIVO`;
                initDashboard();
                sysLog("SESSÃO_INICIADA: UPLINK_SEGURO");
            } else {
                show('login-view');
                hide('dashboard-view');
                sysLog("SISTEMA_AGUARDANDO_AUTENTICAÇÃO_NÍVEL_1");
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                const errEl = document.getElementById('login-error');
                if(errEl) errEl.style.display = 'block';
                sysLog("FALHA_DE_AUTENTICAÇÃO: CHAVE_INVÁLIDA");
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
            sysLog("ENCERRANDO_SESSÃO_CRIPTOGRAFADA...");
            signOut(auth);
        });

        function initDashboard() {
            const notesRef = ref(db, `notes/${currentUser.uid}`);
            onValue(notesRef, (snapshot) => {
                const data = snapshot.val();
                notes = data ? Object.keys(data).map(id => ({ id, ...data[id] })) : [];
                notes.sort((a, b) => b.updatedAt - a.updatedAt);
                renderNotes();
                const syncTimeEl = document.getElementById('sync-time');
                if(syncTimeEl) syncTimeEl.innerText = new Date().toLocaleTimeString();
            });
        }

        function renderNotes() {
            const searchInput = document.getElementById('search-input');
            const term = searchInput ? searchInput.value.toLowerCase() : '';
            const filtered = notes.filter(n => 
                n.title.toLowerCase().includes(term) || 
                n.content.toLowerCase().includes(term) ||
                n.author.toLowerCase().includes(term)
            );
            const grid = document.getElementById('notes-grid');
            if(!grid) return;
            
            if (filtered.length === 0) {
                grid.innerHTML = '<p style="margin-top: 50px; color: #400; letter-spacing: 5px;">NENHUM_REGISTRO_DETECTADO_NA_GRID</p>';
                return;
            }

            grid.innerHTML = filtered.map((note, index) => `
                <div class="note-node">
                    <div class="terminal-card" onclick="viewNote('${note.id}')">
                        <div class="terminal-header">
                            <span>CID_${note.id.slice(0,12).toUpperCase()}</span>
                            <div style="display: flex; gap: 10px;">
                                <span class="status-dot"></span>
                                <span onclick="event.stopPropagation(); editNote('${note.id}')" style="cursor: pointer; color: var(--primary); font-weight: bold;">[MOD]</span>
                                <span onclick="event.stopPropagation(); requestDelete('${note.id}')" style="cursor: pointer; color: #800;">[DEL]</span>
                            </div>
                        </div>
                        <div class="terminal-body">
                            <h3>${note.title}</h3>
                            <p>${note.content}</p>
                        </div>
                        <div class="terminal-footer">
                            <span>OP: ${note.author.toUpperCase()}</span>
                            <span>MOD: ${new Date(note.updatedAt).toLocaleDateString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        const searchInputEl = document.getElementById('search-input');
        if(searchInputEl) searchInputEl.addEventListener('input', renderNotes);

        window.viewNote = (id) => {
            const note = notes.find(n => n.id === id);
            if (!note) return;
            currentViewingId = id;
            document.getElementById('view-title').innerText = note.title;
            document.getElementById('view-content').innerText = note.content;
            document.getElementById('view-author').innerText = `OPERADOR_RESPONSÁVEL: ${note.author.toUpperCase()}`;
            document.getElementById('view-date').innerText = `ÚLTIMA_SINCRONIA: ${new Date(note.updatedAt).toLocaleString()}`;
            document.getElementById('view-header-tag').innerText = `REGISTRO_VISTA_CID: ${id.toUpperCase()}`;
            show('view-modal');
            sysLog(`ACESSANDO_DADOS_CONFIDENCIAIS_CID_${id.slice(0,6)}`);
        };

        window.editNote = (id) => {
            const note = notes.find(n => n.id === id);
            if (!note) return;
            document.getElementById('note-id').value = note.id;
            document.getElementById('note-title').value = note.title;
            document.getElementById('note-author').value = note.author;
            document.getElementById('note-content').value = note.content;
            document.getElementById('edit-modal-title').innerText = 'MODIFICAR_REGISTRO_SISTEMA';
            show('edit-modal');
            hide('view-modal');
        };

        window.requestDelete = (id) => {
            noteToDeleteId = id;
            show('delete-modal');
        };

        document.getElementById('btn-confirm-delete').addEventListener('click', async () => {
            if (noteToDeleteId) {
                await remove(ref(db, `notes/${currentUser.uid}/${noteToDeleteId}`));
                sysLog(`DATA_EXPURGE_SUCCESS: ${noteToDeleteId.slice(0,6)}`);
                hide('delete-modal');
                hide('view-modal');
                noteToDeleteId = null;
            }
        });

        document.getElementById('btn-add').addEventListener('click', () => {
            document.getElementById('note-form').reset();
            document.getElementById('note-id').value = '';
            document.getElementById('note-author').value = 'Giancarlo';
            document.getElementById('edit-modal-title').innerText = 'NOVO_COMMIT_CENTRAL';
            show('edit-modal');
        });

        document.getElementById('note-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('note-id').value;
            const noteData = {
                title: document.getElementById('note-title').value,
                author: document.getElementById('note-author').value,
                content: document.getElementById('note-content').value,
                updatedAt: Date.now()
            };

            if (id) {
                await update(ref(db, `notes/${currentUser.uid}/${id}`), noteData);
                sysLog("BANCO_DE_DADOS_ATUALIZADO");
            } else {
                const newRef = push(ref(db, `notes/${currentUser.uid}`));
                await set(newRef, noteData);
                sysLog("NOVO_REGISTRO_COMMITADO_COM_SUCESSO");
            }
            hide('edit-modal');
        });

        document.getElementById('btn-view-edit').addEventListener('click', () => editNote(currentViewingId));
        document.getElementById('btn-view-delete').addEventListener('click', () => requestDelete(currentViewingId));

    </script>
</body>
</html>
